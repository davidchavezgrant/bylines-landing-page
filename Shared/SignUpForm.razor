@using Bylines.LandingPage.Data
@inject WaitlistDbContext db;
<h3>SignUpForm</h3>

<input placeholder="Name" @bind="form.Name"/>
<input placeholder="Email Address" @bind="form.Email"/>
<input placeholder="Phone Number" @bind="form.PhoneNumber"/>
<input type="checkbox" @bind="form.IsGroup"/>
<button @onclick="Submit">Submit</button>
<h3>@statusMessage</h3>
<h3>Id: @form.Id</h3>

@code
{
    WaitlistSubmissionData form = new();
    string statusMessage = "";

    async Task Submit()
    {
        var validator = new WaitlistDataValidator();
        var result = validator.Validate(form);
        if (!result.IsValid)
        {
            statusMessage = result.Errors?.FirstOrDefault()?.ErrorMessage ?? "An unknown error occured";
        }
        var isDuplicate = db.WaitlistSubmissions.Any(d => d.Email == form.Email) || db.WaitlistSubmissions.Any(d => d.PhoneNumber == form.PhoneNumber);
        if (result.IsValid && !isDuplicate)
        {
            db.WaitlistSubmissions.Add(form);
            var success = await db.SaveChangesAsync();
            if (success is not 1) statusMessage = "Failed to save to database!";
            if (success is 1)
            {
                statusMessage = "Success!";
                form = new WaitlistSubmissionData();
            }
        }
    }
}